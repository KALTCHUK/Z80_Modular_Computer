0001   0000             ;==================================================================================
0002   0000             ; Use Monitor to load this program to 0100h.
0003   0000             ; Switch to CP/M
0004   0000             ; SAVE 2 DOWNLOAD.COM
0005   0000             ;
0006   0000             ; What this program does:
0007   0000             ;	- transfer itself to 0C000h
0008   0000             ;	- receive a block os ASCII bytes starting with ':' and terminated with '#'
0009   0000             ;	- convert the charcters to bytes and write them starting at 0300h
0010   0000             ;	- print the number of pages (you'll need this info for the SAVE x command)
0011   0000             ;	- transfer the block from 0300h to 0100h (beginning of TPA)
0012   0000             ;	- return control to CCP
0013   0000             ;==================================================================================
0014   0000             
0015   0000             TPA		.EQU	0100H
0016   0000             PTPA	.EQU	0300H
0017   0000             NEWLOC	.EQU	0C000H
0018   0000             REBOOT	.EQU	0H
0019   0000             BDOS	.EQU	5H
0020   0000             CONIO	.EQU	6
0021   0000             CONINP	.EQU	1
0022   0000             CONOUT	.EQU	2
0023   0000             PSTRING	.EQU	9
0024   0000             
0025   0000             CR		.EQU	0DH
0026   0000             LF		.EQU	0AH
0027   0000             
0028   0100             	.ORG TPA
0029   0100 11 F8 01    		LD	DE,msgInit
0030   0103 0E 09       		LD	C,PSTRING
0031   0105 CD 05 00    		CALL	BDOS
0032   0108 CD 75 01    		CALL	CRLF
0033   010B             COLON:
0034   010B CD 80 01    		CALL	GETCHR
0035   010E FE 3A       		CP	':'
0036   0110 20 F9       		JR	NZ,COLON
0037   0112 11 00 03    		LD	DE,PTPA						; this is the addr to start writing the incoming block
0038   0115             GETHEX:
0039   0115 CD 80 01    		CALL	GETCHR
0040   0118 FE 23       		CP	'#'							; is it the end?
0041   011A 28 0D       		JR	Z,CLOSE
0042   011C 67          		LD   H,A
0043   011D CD 80 01    		CALL	GETCHR
0044   0120 6F          		LD   L,A
0045   0121 CD C2 01    		CALL	ASCII2HEX
0046   0124 78          		LD	A,B
0047   0125 12          		LD	(DE),A
0048   0126 13          		INC	DE
0049   0127 18 EC       		JR	GETHEX
0050   0129             CLOSE:	
0051   0129 1B          		DEC	DE							; DE contains the last written address
0052   012A CD 75 01    		CALL	CRLF
0053   012D D5          		PUSH	DE
0054   012E 11 2F 02    		LD		DE,msgPages
0055   0131 0E 09       		LD		C,PSTRING
0056   0133 CD 05 00    		CALL	BDOS
0057   0136 D1          		POP		DE
0058   0137 15          		DEC		D
0059   0138 15          		DEC		D
0060   0139 15          		DEC		D
0061   013A 7B          		LD		A,E
0062   013B FE 00       		CP		0
0063   013D 42          		LD		B,D
0064   013E 28 01       		JR		Z,NOINC
0065   0140 04          		INC		B
0066   0141             NOINC:
0067   0141 CD 97 01    		CALL	HEX2ASCII
0068   0144 7C          		LD	A,H
0069   0145 CD 8E 01    		CALL	PUTCHR
0070   0148 7D          		LD	A,L
0071   0149 CD 8E 01    		CALL	PUTCHR
0072   014C CD 75 01    		CALL	CRLF
0073   014F             
0074   014F 11 4B 02    		LD		DE,msgTransf
0075   0152 0E 09       		LD		C,PSTRING
0076   0154 CD 05 00    		CALL	BDOS
0077   0157 CD 75 01    		CALL	CRLF
0078   015A             
0079   015A D5          		PUSH	DE
0080   015B             
0081   015B 01 0C 00    		LD	BC,EBLK-BBLK
0082   015E 11 00 C0    		LD	DE,NEWLOC
0083   0161 21 69 01    		LD	HL,BBLK
0084   0164 ED B0       		LDIR
0085   0166 C3 00 C0    		JP	NEWLOC
0086   0169             BBLK:
0087   0169 C1          		POP		BC					; move loaded program from 0300h to 0100h
0088   016A 11 00 01    		LD	DE,TPA
0089   016D 21 00 03    		LD	HL,PTPA
0090   0170 ED B0       		LDIR
0091   0172 C3 00 00    		JP	REBOOT
0092   0175             
0093   0175             EBLK:
0094   0175             
0095   0175             ;================================================================================================
0096   0175             ; Send CR + LF to console
0097   0175             ;================================================================================================
0098   0175             CRLF: 
0099   0175 3E 0D       		LD	A,CR
0100   0177 CD 8E 01    		CALL	PUTCHR
0101   017A 3E 0A       		LD	A,LF
0102   017C CD 8E 01    		CALL	PUTCHR
0103   017F C9          		RET
0104   0180             
0105   0180             ;================================================================================================
0106   0180             ; Get chat from console
0107   0180             ;================================================================================================
0108   0180             GETCHR: 
0109   0180 D5          		PUSH	DE
0110   0181 1E FF       		LD	E,$FF
0111   0183 0E 06       		LD 	C,CONIO
0112   0185 CD 05 00    		CALL 	BDOS
0113   0188 FE 00       		CP	0
0114   018A 28 F4       		JR	Z,GETCHR
0115   018C D1          		POP		DE
0116   018D C9          		RET
0117   018E             
0118   018E             ;================================================================================================
0119   018E             ; Send char to console
0120   018E             ;================================================================================================
0121   018E             PUTCHR:
0122   018E D5          		PUSH	DE
0123   018F 0E 02       		LD C,CONOUT
0124   0191 5F          		LD E,A
0125   0192 CD 05 00    		CALL BDOS
0126   0195 D1          		POP		DE
0127   0196 C9          		RET
0128   0197             
0129   0197             ;================================================================================================
0130   0197             ; Convert HEX to ASCII (B --> HL)
0131   0197             ;================================================================================================
0132   0197             HEX2ASCII:
0133   0197 C5          		PUSH	BC
0134   0198 78          		LD	A,B
0135   0199 E6 0F       		AND	0FH
0136   019B 6F          		LD	L,A
0137   019C D6 0A       		SUB	0AH
0138   019E 0E 30       		LD	C,030H
0139   01A0 DA A5 01    		JP	C,COMPENSATE
0140   01A3 0E 37       		LD	C,037H
0141   01A5             COMPENSATE:
0142   01A5 7D          		LD	A,L
0143   01A6 81          		ADD	A,C
0144   01A7 6F          		LD	L,A
0145   01A8 78          		LD	A,B
0146   01A9 E6 F0       		AND	0F0H
0147   01AB CB 3F       		SRL	A
0148   01AD CB 3F       		SRL	A
0149   01AF CB 3F       		SRL	A
0150   01B1 CB 3F       		SRL	A
0151   01B3 67          		LD	H,A
0152   01B4 D6 0A       		SUB	0AH
0153   01B6 0E 30       		LD	C,030H
0154   01B8 DA BD 01    		JP	C,COMPENSATE2
0155   01BB 0E 37       		LD	C,037H
0156   01BD             COMPENSATE2:
0157   01BD 7C          		LD	A,H
0158   01BE 81          		ADD	A,C
0159   01BF 67          		LD	H,A
0160   01C0 C1          		POP	BC
0161   01C1 C9          		RET
0162   01C2             
0163   01C2             ;================================================================================================
0164   01C2             ; Convert ASCII to HEX (HL --> B)
0165   01C2             ;================================================================================================
0166   01C2 C5          ASCII2HEX:	PUSH	BC
0167   01C3 3E 60       		LD	A,060H
0168   01C5 94          		SUB	H
0169   01C6 0E 57       		LD	C,057H
0170   01C8 DA D5 01    		JP	C,DISCOUNT
0171   01CB 3E 40       		LD	A,040H
0172   01CD 94          		SUB	H
0173   01CE 0E 37       		LD	C,037H
0174   01D0 DA D5 01    		JP	C,DISCOUNT
0175   01D3 0E 30       		LD	C,030H
0176   01D5             DISCOUNT:
0177   01D5 7C          		LD	A,H
0178   01D6 91          		SUB	C
0179   01D7             CONVL:
0180   01D7 47          		LD	B,A
0181   01D8 CB 20       		SLA	B
0182   01DA CB 20       		SLA	B
0183   01DC CB 20       		SLA	B
0184   01DE CB 20       		SLA	B
0185   01E0             
0186   01E0 3E 60       		LD	A,060H
0187   01E2 95          		SUB	L
0188   01E3 0E 57       		LD	C,057H
0189   01E5 DA F2 01    		JP	C,DISCOUNT2
0190   01E8 3E 40       		LD	A,040H
0191   01EA 95          		SUB	L
0192   01EB 0E 37       		LD	C,037H
0193   01ED DA F2 01    		JP	C,DISCOUNT2
0194   01F0 0E 30       		LD	C,030H
0195   01F2             DISCOUNT2:
0196   01F2 7D          		LD	A,L
0197   01F3 91          		SUB	C
0198   01F4 B0          		OR	B
0199   01F5 C1          		POP	BC
0200   01F6 47          		LD	B,A
0201   01F7 C9          		RET
0202   01F8             
0203   01F8             ;================================================================================================
0204   01F8             ; Message area
0205   01F8             ;================================================================================================
0206   01F8 53 65 6E 64 msgInit	 		.BYTE	"Send ASCII block starting with ':' and ending with '#'$"
0206   01FC 20 41 53 43 
0206   0200 49 49 20 62 
0206   0204 6C 6F 63 6B 
0206   0208 20 73 74 61 
0206   020C 72 74 69 6E 
0206   0210 67 20 77 69 
0206   0214 74 68 20 27 
0206   0218 3A 27 20 61 
0206   021C 6E 64 20 65 
0206   0220 6E 64 69 6E 
0206   0224 67 20 77 69 
0206   0228 74 68 20 27 
0206   022C 23 27 24 
0207   022F 4E 75 6D 62 msgPages 		.BYTE	"Number of pages written: 0x$"
0207   0233 65 72 20 6F 
0207   0237 66 20 70 61 
0207   023B 67 65 73 20 
0207   023F 77 72 69 74 
0207   0243 74 65 6E 3A 
0207   0247 20 30 78 24 
0208   024B 54 72 61 6E msgTransf 		.BYTE	"Transfering block to TPA... $"
0208   024F 73 66 65 72 
0208   0253 69 6E 67 20 
0208   0257 62 6C 6F 63 
0208   025B 6B 20 74 6F 
0208   025F 20 54 50 41 
0208   0263 2E 2E 2E 20 
0208   0267 24 
0209   0268             
0210   0268             
0211   0268             		.END
0212   0268             
0213   0268             
0214   0268             
tasm: Number of errors = 0
