0001   0000             ;==================================================================================
0002   0000             ; READ CONSOLE, ECHO AND WRITE TO FILE
0003   0000             ;==================================================================================
0004   0000             REBOOT		.EQU	0H
0005   0000             BDOS		.EQU	5H
0006   0000             TPA			.EQU	0100H
0007   0000             
0008   0000             C_READ		.EQU	1
0009   0000             C_WRITE		.EQU	2
0010   0000             C_RAWIO		.EQU	6
0011   0000             C_WRITESTR	.EQU	9
0012   0000             F_CLOSE		.EQU	16
0013   0000             F_DELETE	.EQU	19
0014   0000             F_WRITE		.EQU	21
0015   0000             F_MAKE		.EQU	22
0016   0000             F_DMAOFF	.EQU	26
0017   0000             
0018   0000             CTRLC		.EQU	03H
0019   0000             EOT			.EQU	023H		;04H
0020   0000             ACK			.EQU	024H		;06H
0021   0000             LF			.EQU	0AH
0022   0000             CR			.EQU	0DH
0023   0000             NAK			.EQU	025H		;015H
0024   0000             EM			.EQU	026H		;019H
0025   0000             SUB			.EQU	01AH
0026   0000             		
0027   0000             FCB			.EQU	0005CH
0028   0000             FCBEX		.EQU	FCB+12
0029   0000             FCBCR		.EQU	FCB+32
0030   0000             DMA			.EQU	080H
0031   0000             ;==================================================================================
0032   0100             			.ORG TPA
0033   0100             
0034   0100 21 80 00    			LD	HL,DMA
0035   0103 22 B1 02    			LD	(BUFFPTR),HL
0036   0106             			
0037   0106 CD 79 01    			CALL SETDMA			; Set DMA
0038   0109 CD 82 01    			CALL DELFILE		; Delete and create file
0039   010C CD 9A 01    			CALL MAKEFILE
0040   010F             
0041   010F 11 17 02    			LD	DE,MSGINI		; Greeting message
0042   0112 0E 09       			LD	C,C_WRITESTR
0043   0114 CD 05 00    			CALL BDOS
0044   0117             
0045   0117 CD 56 01    NEXTCHAR:	CALL GETCHAR		; Read console and echo it
0046   011A FE 03       			CP	CTRLC			; If char is CTRL-C, stop reading console
0047   011C 28 15       			JR	Z,DONE
0048   011E F5          NOTCR:		PUSH AF
0049   011F CD 69 01    			CALL WRBUFF
0050   0122 F1          			POP	AF
0051   0123 FE 0D       			CP	CR
0052   0125 20 F0       			JR	NZ,NEXTCHAR
0053   0127 3E 0A       			LD	A,LF
0054   0129 CD 69 01    			CALL WRBUFF
0055   012C 3E 0A       			LD	A,LF
0056   012E CD 62 01    			CALL PUTCHAR
0057   0131 18 E4       			JR	NEXTCHAR
0058   0133             			
0059   0133 3E 1A       DONE:		LD	A,SUB
0060   0135 CD 69 01    			CALL WRBUFF
0061   0138 21 80 00    			LD	HL,DMA			; Check if buffer is empty
0062   013B EB          			EX	DE,HL
0063   013C 2A B1 02    			LD	HL,(BUFFPTR)
0064   013F 37          			SCF
0065   0140 3F          			CCF
0066   0141 ED 52       			SBC	HL,DE
0067   0143 28 03       			JR	Z,JUSTCLOSE
0068   0145 CD B2 01    			CALL WRITEBLK
0069   0148             			
0070   0148 CD C1 01    JUSTCLOSE:	CALL CLOSEFILE
0071   014B 11 35 02    			LD	DE,MSGEND		; Exit message
0072   014E 0E 09       			LD	C,C_WRITESTR
0073   0150 CD 05 00    			CALL BDOS
0074   0153 C3 00 00    			JP	REBOOT
0075   0156             
0076   0156             ;==================================================================================
0077   0156             ; Wait for a char and return it on A (no echo)
0078   0156             ;==================================================================================
0079   0156 1E FF       GETCHAR:	LD	E,0FFH
0080   0158 0E 01       			LD 	C,C_READ
0081   015A CD 05 00    			CALL BDOS
0082   015D FE 00       			CP	0
0083   015F 28 F5       			JR	Z,GETCHAR
0084   0161 C9          			RET
0085   0162             
0086   0162             ;==================================================================================
0087   0162             ; Write A to output
0088   0162             ;==================================================================================
0089   0162 0E 02       PUTCHAR:	LD C,C_WRITE
0090   0164 5F          			LD E,A
0091   0165 CD 05 00    			CALL BDOS
0092   0168 C9          			RET
0093   0169             
0094   0169             ;==================================================================================
0095   0169             ; Write char in regA to Buffer
0096   0169             ;==================================================================================
0097   0169 2A B1 02    WRBUFF:		LD	HL,(BUFFPTR)	; Put char in buffer
0098   016C 77          			LD	(HL),A
0099   016D 23          			INC	HL
0100   016E 22 B1 02    			LD	(BUFFPTR),HL
0101   0171 7C          			LD	A,H
0102   0172 FE 01       			CP	1
0103   0174 C0          			RET NZ
0104   0175 CD B2 01    			CALL WRITEBLK
0105   0178 C9          			RET
0106   0179             
0107   0179             ;==================================================================================
0108   0179             ; Set DMA
0109   0179             ;==================================================================================
0110   0179 0E 1A       SETDMA:		LD	C,F_DMAOFF
0111   017B 11 80 00    			LD	DE,DMA
0112   017E CD 05 00    			CALL BDOS
0113   0181 C9          			RET
0114   0182             
0115   0182             ;==================================================================================
0116   0182             ; Delete file
0117   0182             ;==================================================================================
0118   0182 11 5D 02    DELFILE:	LD	DE,MSGDF		; message
0119   0185 0E 09       			LD	C,C_WRITESTR
0120   0187 CD 05 00    			CALL BDOS
0121   018A             
0122   018A 0E 13       			LD	C,F_DELETE
0123   018C 11 5C 00    			LD	DE,FCB
0124   018F CD 05 00    			CALL BDOS
0125   0192             			
0126   0192 47          			LD	B,A
0127   0193 CD EC 01    			CALL B2HL
0128   0196 CD D9 01    			CALL PRTNUM
0129   0199 C9          			RET
0130   019A             
0131   019A             ;==================================================================================
0132   019A             ; Make file
0133   019A             ;==================================================================================
0134   019A 11 72 02    MAKEFILE:	LD	DE,MSGMF		; message
0135   019D 0E 09       			LD	C,C_WRITESTR
0136   019F CD 05 00    			CALL BDOS
0137   01A2             
0138   01A2 0E 16       			LD	C,F_MAKE
0139   01A4 11 5C 00    			LD	DE,FCB
0140   01A7 CD 05 00    			CALL BDOS
0141   01AA             
0142   01AA 47          			LD	B,A
0143   01AB CD EC 01    			CALL B2HL
0144   01AE CD D9 01    			CALL PRTNUM
0145   01B1 C9          			RET
0146   01B2             
0147   01B2             ;==================================================================================
0148   01B2             ; Write block to file
0149   01B2             ;==================================================================================
0150   01B2 0E 15       WRITEBLK:	LD	C,F_WRITE
0151   01B4 11 5C 00    			LD	DE,FCB
0152   01B7 CD 05 00    			CALL BDOS
0153   01BA 21 80 00    			LD	HL,DMA			; Restart buffer pointer 
0154   01BD 22 B1 02    			LD	(BUFFPTR),HL
0155   01C0 C9          			RET
0156   01C1             
0157   01C1             ;==================================================================================
0158   01C1             ; Close file
0159   01C1             ;==================================================================================
0160   01C1 11 87 02    CLOSEFILE:	LD	DE,MSGCF		; message
0161   01C4 0E 09       			LD	C,C_WRITESTR
0162   01C6 CD 05 00    			CALL BDOS
0163   01C9             
0164   01C9 0E 10       			LD	C,F_CLOSE
0165   01CB 11 5C 00    			LD	DE,FCB
0166   01CE CD 05 00    			CALL BDOS
0167   01D1             
0168   01D1 47          			LD	B,A
0169   01D2 CD EC 01    			CALL B2HL
0170   01D5 CD D9 01    			CALL PRTNUM
0171   01D8 C9          			RET
0172   01D9             
0173   01D9             ;==================================================================================
0174   01D9             ; Print a 2-digit number + LF + CR (number in HL)
0175   01D9             ;==================================================================================
0176   01D9 7C          PRTNUM:		LD	A,H
0177   01DA CD 62 01    			CALL PUTCHAR
0178   01DD 7D          			LD	A,L
0179   01DE CD 62 01    			CALL PUTCHAR
0180   01E1 3E 0D       			LD	A,CR
0181   01E3 CD 62 01    			CALL PUTCHAR
0182   01E6 3E 0A       			LD	A,LF
0183   01E8 CD 62 01    			CALL PUTCHAR
0184   01EB C9          			RET
0185   01EC             
0186   01EC             ;================================================================================================
0187   01EC             ; Convert HEX to ASCII (B --> HL)
0188   01EC             ;================================================================================================
0189   01EC C5          B2HL:		PUSH	BC
0190   01ED 78          			LD	A,B
0191   01EE E6 0F       			AND	0FH
0192   01F0 6F          			LD	L,A
0193   01F1 D6 0A       			SUB	0AH
0194   01F3 0E 30       			LD	C,030H
0195   01F5 DA FA 01    			JP	C,COMP
0196   01F8 0E 37       			LD	C,037H
0197   01FA 7D          COMP:		LD	A,L
0198   01FB 81          			ADD	A,C
0199   01FC 6F          			LD	L,A
0200   01FD 78          			LD	A,B
0201   01FE E6 F0       			AND	0F0H
0202   0200 CB 3F       			SRL	A
0203   0202 CB 3F       			SRL	A
0204   0204 CB 3F       			SRL	A
0205   0206 CB 3F       			SRL	A
0206   0208 67          			LD	H,A
0207   0209 D6 0A       			SUB	0AH
0208   020B 0E 30       			LD	C,030H
0209   020D DA 12 02    			JP	C,COMP2
0210   0210 0E 37       			LD	C,037H
0211   0212 7C          COMP2:		LD	A,H
0212   0213 81          			ADD	A,C
0213   0214 67          			LD	H,A
0214   0215 C1          			POP	BC
0215   0216 C9          			RET
0216   0217             
0217   0217             ;==================================================================================
0218   0217 54 59 50 45 MSGINI		.DB		"TYPE CTRL-C TO END PROGRAM.", CR, LF, "$"
0218   021B 20 43 54 52 
0218   021F 4C 2D 43 20 
0218   0223 54 4F 20 45 
0218   0227 4E 44 20 50 
0218   022B 52 4F 47 52 
0218   022F 41 4D 2E 0D 
0218   0233 0A 24 
0219   0235 0D 0A 45 4E MSGEND		.DB		CR, LF, "END OF PROGRAM. RETURNING TO CCP...", CR, LF, "$"
0219   0239 44 20 4F 46 
0219   023D 20 50 52 4F 
0219   0241 47 52 41 4D 
0219   0245 2E 20 52 45 
0219   0249 54 55 52 4E 
0219   024D 49 4E 47 20 
0219   0251 54 4F 20 43 
0219   0255 43 50 2E 2E 
0219   0259 2E 0D 0A 24 
0220   025D 44 45 4C 45 MSGDF		.DB		"DELETE FILE RETURN: $"
0220   0261 54 45 20 46 
0220   0265 49 4C 45 20 
0220   0269 52 45 54 55 
0220   026D 52 4E 3A 20 
0220   0271 24 
0221   0272 4D 41 4B 45 MSGMF		.DB		"MAKE FILE RETURN  : $"
0221   0276 20 46 49 4C 
0221   027A 45 20 52 45 
0221   027E 54 55 52 4E 
0221   0282 20 20 3A 20 
0221   0286 24 
0222   0287 43 4C 4F 53 MSGCF		.DB		"CLOSE FILE RETURN : $"
0222   028B 45 20 46 49 
0222   028F 4C 45 20 52 
0222   0293 45 54 55 52 
0222   0297 4E 20 3A 20 
0222   029B 24 
0223   029C 57 52 49 54 MSGWB		.DB		"WRITE BLOCK RETURN: $"
0223   02A0 45 20 42 4C 
0223   02A4 4F 43 4B 20 
0223   02A8 52 45 54 55 
0223   02AC 52 4E 3A 20 
0223   02B0 24 
0224   02B1             
0225   02B1 00 00       BUFFPTR		.DW	0000H
0226   02B3             
0227   02B3             			.DS	020h			; Start of stack area.
0228   02D3             STACK:		.EQU	$
0229   02D3             
0230   02D3             			.END
tasm: Number of errors = 0
