0001   0000             ;================================================================================================
0002   0000             ; Compact Flash Test Routines
0003   0000             ;
0004   0000             ;================================================================================================
0005   0000             CF_INIT			.EQU	0200H			; Routine to initialize the CF
0006   0000             DISK_TAB		.EQU	0280H			; Disk physical address table
0007   0000             ;				disk	0280h
0008   0000             ;				track 	0281h
0009   0000             ;				sector	0283h
0010   0000             FILL_PAD		.EQU	0300H			; Fill scratch pad with content of addr SET_PAD+2 
0011   0000             FILL_PAD_SAW	.EQU	0380H			; Fill scratch pad with saw tooth pattern
0012   0000             CF_RD			.EQU	0400H			; Routine to read from CF
0013   0000             CF_WR			.EQU	0500H			; Routine to write to CF
0014   0000             SCRATCHPAD		.EQU	01000H			; 512 bytes (= 1 sector) read/write scratch pad
0015   0000             
0016   0000             PRINTSEQ		.EQU	0E633H			; Routine (located in the BIOS) to print a sequence of characters
0017   0000             WAITCMD			.EQU	0D131H			; Reentry point to Monitor
0018   0000             CONST			.EQU	0E606H			; Entry point for BIOS function CONST
0019   0000             CONIN			.EQU	0E609H			; Entry point for BIOS function CONIN
0020   0000             CONOUT			.EQU	0E60CH			; Entry point for BIOS function CONOUT
0021   0000             
0022   0000             FLASH_ADDR		.EQU	0B0H			; Base I/O address for compact flash card
0023   0000             ; CF registers
0024   0000             CF_DATA			.EQU	(FLASH_ADDR+0)	; R/W
0025   0000             CF_FEATURES		.EQU	(FLASH_ADDR+1)	; W
0026   0000             CF_ERROR		.EQU	(FLASH_ADDR+1)	; R
0027   0000             CF_SECCOUNT		.EQU	(FLASH_ADDR+2)	; W
0028   0000             
0029   0000             CF_SECTOR		.EQU	(FLASH_ADDR+3)	; W
0030   0000             CF_CYL_LOW		.EQU	(FLASH_ADDR+4)	; W
0031   0000             CF_CYL_HI		.EQU	(FLASH_ADDR+5)	; W
0032   0000             CF_HEAD			.EQU	(FLASH_ADDR+6)	; W
0033   0000             
0034   0000             CF_LBA0			.EQU	(FLASH_ADDR+3)	; W
0035   0000             CF_LBA1			.EQU	(FLASH_ADDR+4)	; W
0036   0000             CF_LBA2			.EQU	(FLASH_ADDR+5)	; W
0037   0000             CF_LBA3			.EQU	(FLASH_ADDR+6)	; W
0038   0000             
0039   0000             CF_STATUS		.EQU	(FLASH_ADDR+7)	; R
0040   0000             CF_COMMAND		.EQU	(FLASH_ADDR+7)	; W
0041   0000             
0042   0000             ;CF Features
0043   0000             CF_8BIT			.EQU	1
0044   0000             CF_NOCACHE		.EQU	082H
0045   0000             
0046   0000             ;CF Commands
0047   0000             CF_READ_SEC		.EQU	020H
0048   0000             CF_WRITE_SEC	.EQU	030H
0049   0000             CF_SET_FEAT		.EQU 	0EFH
0050   0000             
0051   0000             LF				.EQU	0AH				; line feed
0052   0000             FF				.EQU	0CH				; form feed
0053   0000             CR				.EQU	0DH				; carriage return
0054   0000             SPACE			.EQU	020H			; space
0055   0000             COLON			.EQU	03AH			; colon
0056   0000             
0057   0000             ;================================================================================================
0058   0000             ; Compact flash initialization
0059   0000             ;================================================================================================
0060   0200             		.ORG CF_INIT
0061   0200             
0062   0200 CD 53 05    		CALL	CFWAIT
0063   0203 3E 01       		LD 	A,CF_8BIT					; Set IDE to be 8bit
0064   0205 D3 B1       		OUT	(CF_FEATURES),A
0065   0207 3E EF       		LD	A,CF_SET_FEAT
0066   0209 D3 B7       		OUT	(CF_COMMAND),A
0067   020B             
0068   020B             
0069   020B CD 53 05    		CALL	CFWAIT
0070   020E 3E 82       		LD 	A,CF_NOCACHE				; No write cache
0071   0210 D3 B1       		OUT	(CF_FEATURES),A
0072   0212 3E EF       		LD	A,CF_SET_FEAT
0073   0214 D3 B7       		OUT	(CF_COMMAND),A
0074   0216             
0075   0216 CD 33 E6    		CALL	PRINTSEQ
0076   0219 46 6C 61 73 		.TEXT	"Flash initialized."
0076   021D 68 20 69 6E 
0076   0221 69 74 69 61 
0076   0225 6C 69 7A 65 
0076   0229 64 2E 
0077   022B 0D 0A 00    		.DB CR,LF,0
0078   022E             
0079   022E C3 31 D1    		JP	WAITCMD
0080   0231             		
0081   0280             		.ORG	DISK_TAB
0082   0280 00          DISK	.DB		0
0083   0281 00 00       TRACK	.DW		0
0084   0283 00          SECTOR	.DB		0
0085   0284             		
0086   0284 00          LBA0	.DB		0
0087   0285 00          LBA1	.DB		0
0088   0286 00          LBA2	.DB		0
0089   0287             
0090   0287             ;================================================================================================
0091   0287             ; Compact flash read 1 sector and write to SCRATCHPAD
0092   0287             ;================================================================================================
0093   0400             		.ORG CF_RD
0094   0400 CD 5C 05    		CALL	DTS2LBA
0095   0403             		
0096   0403 CD 53 05    		CALL 	CFWAIT
0097   0406             
0098   0406 3A 84 02    		LD	A,(LBA0)
0099   0409 D3 B3       		OUT 	(CF_LBA0),A
0100   040B 3A 85 02    		LD	A,(LBA1)
0101   040E D3 B4       		OUT 	(CF_LBA1),A
0102   0410 3A 86 02    		LD	A,(LBA2)
0103   0413 D3 B5       		OUT 	(CF_LBA2),A
0104   0415 3E E0       		LD	A,0E0H
0105   0417 D3 B6       		OUT 	(CF_LBA3),A
0106   0419 3E 01       		LD 	A,1
0107   041B D3 B2       		OUT 	(CF_SECCOUNT),A
0108   041D             
0109   041D 3E 20       		LD 	A,CF_READ_SEC
0110   041F D3 B7       		OUT 	(CF_COMMAND),A
0111   0421             
0112   0421 CD 53 05    		CALL 	CFWAIT
0113   0424             
0114   0424 01 00 02    		LD	BC,0200H
0115   0427 11 00 10    		LD	DE,SCRATCHPAD
0116   042A 00          rdByte:	NOP
0117   042B DB B0       		IN	A,(CF_DATA)
0118   042D 12          		LD	(DE),A
0119   042E 13          		INC	DE
0120   042F 0B          		DEC	BC
0121   0430 78          		LD	A,B
0122   0431 B1          		OR	C
0123   0432 20 F6       		JR 	NZ, rdByte
0124   0434             
0125   0434 CD 33 E6    		CALL	PRINTSEQ
0126   0437 46 6C 61 73 		.TEXT	"Flash read completed."
0126   043B 68 20 72 65 
0126   043F 61 64 20 63 
0126   0443 6F 6D 70 6C 
0126   0447 65 74 65 64 
0126   044B 2E 
0127   044C 0D 0A 00    		.DB CR,LF,0
0128   044F             
0129   044F C3 31 D1    		JP	WAITCMD
0130   0452             
0131   0452             ;================================================================================================
0132   0452             ; Compact flash write 1 sector from SCRATCHPAD
0133   0452             ;================================================================================================
0134   0500             		.ORG CF_WR
0135   0500 CD 5C 05    		CALL	DTS2LBA
0136   0503             		
0137   0503 CD 53 05    		CALL 	CFWAIT
0138   0506             
0139   0506 3A 84 02    		LD	A,(LBA0)
0140   0509 D3 B3       		OUT (CF_LBA0),A
0141   050B 3A 85 02    		LD	A,(LBA1)
0142   050E D3 B4       		OUT (CF_LBA1),A
0143   0510 3A 86 02    		LD	A,(LBA2)
0144   0513 D3 B5       		OUT (CF_LBA2),A
0145   0515 3E E0       		LD	A,0E0H
0146   0517 D3 B6       		OUT	(CF_LBA3),A
0147   0519 3E 01       		LD 	A,1
0148   051B D3 B2       		OUT	(CF_SECCOUNT),A
0149   051D             
0150   051D 3E 30       		LD 	A,CF_WRITE_SEC
0151   051F D3 B7       		OUT	(CF_COMMAND),A
0152   0521             
0153   0521 CD 53 05    		CALL 	CFWAIT
0154   0524             
0155   0524 01 00 02    		LD	BC,0200H
0156   0527 11 00 10    		LD	DE,SCRATCHPAD
0157   052A 1A          wrByte:	LD	A,(DE)
0158   052B 00          		NOP
0159   052C D3 B0       		OUT (CF_DATA),A
0160   052E 13          		INC	DE
0161   052F 0B          		DEC	BC
0162   0530 78          		LD	A,B
0163   0531 B1          		OR	C
0164   0532 20 F6       		JR 	NZ, wrByte
0165   0534             
0166   0534 CD 33 E6    		CALL	PRINTSEQ
0167   0537 46 6C 61 73 		.TEXT	"Flash write completed."
0167   053B 68 20 77 72 
0167   053F 69 74 65 20 
0167   0543 63 6F 6D 70 
0167   0547 6C 65 74 65 
0167   054B 64 2E 
0168   054D 0D 0A 00    		.DB CR,LF,0
0169   0550             
0170   0550 C3 31 D1    		JP	WAITCMD
0171   0553             
0172   0553             ;================================================================================================
0173   0553             ; Wait for disk to be ready
0174   0553             ;================================================================================================
0175   0553             CFWAIT:
0176   0553 F5          		PUSH 	AF
0177   0554             CFWAIT1:
0178   0554 DB B7       		IN 	A,(CF_STATUS)
0179   0556 E6 80       		AND 080H
0180   0558 20 FA       		JR	NZ,CFWAIT1
0181   055A             
0182   055A F1          		POP AF
0183   055B C9          		RET
0184   055C             
0185   055C             ;================================================================================================
0186   055C             ; Convert physical address (disk, track, sector) to LBA address.
0187   055C             ;================================================================================================
0188   055C             DTS2LBA:
0189   055C 2A 81 02    		LD	HL,(TRACK)
0190   055F CB 05       		RLC	L
0191   0561 CB 05       		RLC	L
0192   0563 CB 05       		RLC	L
0193   0565 CB 05       		RLC	L
0194   0567 CB 05       		RLC	L
0195   0569 7D          		LD	A,L
0196   056A E6 E0       		AND	0E0H
0197   056C 6F          		LD	L,A
0198   056D 3A 83 02    		LD	A,(SECTOR)
0199   0570 85          		ADD	A,L
0200   0571 32 84 02    		LD	(LBA0),A
0201   0574             
0202   0574 2A 81 02    		LD	HL,(TRACK)
0203   0577 CB 0D       		RRC	L
0204   0579 CB 0D       		RRC	L
0205   057B CB 0D       		RRC	L
0206   057D 7D          		LD	A,L
0207   057E E6 1F       		AND	01FH
0208   0580 6F          		LD	L,A
0209   0581 CB 04       		RLC	H
0210   0583 CB 04       		RLC	H
0211   0585 CB 04       		RLC	H
0212   0587 CB 04       		RLC	H
0213   0589 CB 04       		RLC	H
0214   058B 7C          		LD	A,H
0215   058C E6 20       		AND	020H
0216   058E 67          		LD	H,A
0217   058F 3A 80 02    		LD	A,(DISK)
0218   0592 CB 07       		RLC	a
0219   0594 CB 07       		RLC	a
0220   0596 CB 07       		RLC	a
0221   0598 CB 07       		RLC	a
0222   059A CB 07       		RLC	a
0223   059C CB 07       		RLC	a
0224   059E E6 C0       		AND	0C0H
0225   05A0 84          		ADD	A,H
0226   05A1 85          		ADD	A,L
0227   05A2 32 85 02    		LD	(LBA1),A
0228   05A5             		
0229   05A5             
0230   05A5 3A 80 02    		LD	A,(DISK)
0231   05A8 CB 0F       		RRC	A
0232   05AA CB 0F       		RRC	A
0233   05AC E6 03       		AND	03H
0234   05AE 32 86 02    		LD	(LBA2),A
0235   05B1             
0236   05B1 C9          		RET
0237   05B2             
0238   05B2             ;================================================================================================
0239   05B2             ; Fill scratch pad with content of addr 'SET_PAD+2' 
0240   05B2             ;================================================================================================
0241   0300             		.ORG	FILL_PAD
0242   0300             
0243   0300 18 01       		JR	SKIPBYTE
0244   0302             
0245   0302 00          SET_BYTE	.DB	0						; this byte will be used to fill the scratch pad
0246   0303             
0247   0303 01 00 02    SKIPBYTE:	LD	BC,0200H
0248   0306 11 00 10    		LD	DE,SCRATCHPAD
0249   0309 3A 02 03    SETNEXT:	LD	A,(SET_BYTE)
0250   030C 12          		LD	(DE),A
0251   030D 13          		INC	DE
0252   030E 0B          		DEC	BC
0253   030F 78          		LD	A,B
0254   0310 B1          		OR	C
0255   0311 20 F6       		JR	NZ,SETNEXT
0256   0313             
0257   0313 CD 33 E6    		CALL	PRINTSEQ
0258   0316 46 69 6C 6C 		.TEXT	"Fill scratch pad completed."
0258   031A 20 73 63 72 
0258   031E 61 74 63 68 
0258   0322 20 70 61 64 
0258   0326 20 63 6F 6D 
0258   032A 70 6C 65 74 
0258   032E 65 64 2E 
0259   0331 0D 0A 00    		.DB CR,LF,0
0260   0334             
0261   0334 C3 31 D1    		JP	WAITCMD
0262   0337             
0263   0337             ;================================================================================================
0264   0337             ; Fill scratch pad with saw tooth pattern (00, FF, FE, FD, FC, FB, FA... 03, 02, 01, 00...)
0265   0337             ;================================================================================================
0266   0380             		.ORG	FILL_PAD_SAW
0267   0380             
0268   0380 01 00 02    		LD	BC,0200H
0269   0383 21 00 10    		LD	HL,SCRATCHPAD
0270   0386 3A 02 03    STNXTD:	LD	A,(SET_BYTE)
0271   0389 71          		LD	(HL),C
0272   038A 23          		INC	HL
0273   038B 0B          		DEC	BC
0274   038C 78          		LD	A,B
0275   038D B1          		OR	C
0276   038E 20 F6       		JR	NZ,STNXTD
0277   0390             
0278   0390 CD 33 E6    		CALL	PRINTSEQ
0279   0393 53 61 77 20 		.TEXT	"Saw tooth pattern fill scratch pad completed."
0279   0397 74 6F 6F 74 
0279   039B 68 20 70 61 
0279   039F 74 74 65 72 
0279   03A3 6E 20 66 69 
0279   03A7 6C 6C 20 73 
0279   03AB 63 72 61 74 
0279   03AF 63 68 20 70 
0279   03B3 61 64 20 63 
0279   03B7 6F 6D 70 6C 
0279   03BB 65 74 65 64 
0279   03BF 2E 
0280   03C0 0D 0A 00    		.DB CR,LF,0
0281   03C3             
0282   03C3 C3 31 D1    		JP	WAITCMD
0283   03C6             		.END
tasm: Number of errors = 0
