---------------------------------------------
Z80 ASSEMBLER LISTING
Line   Addr Opcode      Label   Instruction
---------------------------------------------
0001   0000             ;==================================================================================
0002   0000             ; XMODEM.ASM version 1 - Kaltchuk, feb/2021
0003   0000             ;
0004   0000             ; This program implements xmodem protocol on CP/M.
0005   0000             ; (3 bytes header, 128byte data packets, 1byte CheckSum).
0006   0000             ;
0007   0000             ; +-------- header --------+------- data packet -------+
0008   0000             ; |                        |                           |
0009   0000             ;  <SOH> <BlkNum> </BlkNum> <byte1> <byte2>...<byte128> <ChkSum>
0010   0000             ;==================================================================================
0011   0000             
0012   0000             SOH			.EQU	01H				; ASCII characters
0013   0000             EOT			.EQU	04H
0014   0000             ACK			.EQU	06H
0015   0000             LF			.EQU	0AH
0016   0000             CR			.EQU	0DH
0017   0000             NAK			.EQU	015H
0018   0000             CAN			.EQU	018H
0019   0000             SUB			.EQU	01AH
0020   0000             
0021   0000             MAXTRY		.EQU	5
0022   0000             
0023   0000             USART_DAT	.EQU	80H
0024   0000             USART_STA	.EQU	81H
0025   0000             ;==================================================================================
0026   0000             			.ORG 0
0027   0000             
0028   0000 CD 1D 00    GETBYTE:	CALL SENDNAK
0029   0003 06 04       			LD	B,4
0030   0005 CD 29 00    			CALL TOCONIN			;10s timeout
0031   0008 38 01       			JR	C,REPEAT			; Timed out?
0032   000A 76          			HALT
0033   000B 3A 6D 00    REPEAT:		LD	A,(RETRY)
0034   000E 3C          			INC	A
0035   000F 32 6D 00    			LD	(RETRY),A
0036   0012 FE 05       			CP	MAXTRY
0037   0014 20 EA       			JR	NZ,GETBYTE			; Try again?
0038   0016 76          			HALT
0039   0017             
0040   0017             ;==================================================================================
0041   0017             ; Send ACK
0042   0017             ;==================================================================================
0043   0017 0E 41       SENDACK:	LD C,'A'
0044   0019 CD 69 00    			CALL CONOUT
0045   001C C9          			RET
0046   001D             
0047   001D             ;==================================================================================
0048   001D             ; Send NAK
0049   001D             ;==================================================================================
0050   001D 0E 4E       SENDNAK:	LD C,'N'
0051   001F CD 69 00    			CALL CONOUT
0052   0022 C9          			RET
0053   0023             
0054   0023             ;==================================================================================
0055   0023             ; Send CAN
0056   0023             ;==================================================================================
0057   0023 0E 43       SENDCAN:	LD C,'C'
0058   0025 CD 69 00    			CALL CONOUT
0059   0028 C9          			RET
0060   0029             
0061   0029             ;==================================================================================
0062   0029             ; Timed Out Console Input - X seconds, with X passed on reg B
0063   0029             ; Incoming byte, if any, returns in A
0064   0029             ; Carry flag set if timed out.
0065   0029             ;==================================================================================
0066   0029 C5          TOCONIN:	PUSH	BC
0067   002A E5          			PUSH	HL
0068   002B 21 02 00    LOOP0:		LD	HL,2				;2.5					\
0069   002E 0E 03       LOOP1:		LD	C,3				;1.75	\				|
0070   0030 00          LOOP2:		NOP						;1		|				|
0071   0031 CD 4E 00    			CALL CONST				;36.5	|t=41.5C+0.5	|
0072   0034 3C          			INC	A					;1		|				|
0073   0035 28 10       			JR	Z,BWAITING			;3/1.75	|				| t=HL(41.5C+6.5)+1.25
0074   0037 0D          			DEC	C					;1		|				|
0075   0038 20 F6       			JR	NZ,LOOP2			;3/1.75	/				| with HL=685 and c=35,
0076   003A 2B          			DEC	HL					;1						|  t=0.9994sec (WOW!!!)
0077   003B 7C          			LD	A,H					;1						|
0078   003C B5          			OR	L					;1						|
0079   003D CD 17 00    			CALL SENDACK
0080   0040 20 EC       			JR	NZ,LOOP1			;3/1.75					/
0081   0042 10 E7       			DJNZ	LOOP0			;3.25/2
0082   0044 37          			SCF
0083   0045 18 04       			JR	TOUT
0084   0047 CD 5B 00    BWAITING:	CALL CONIN
0085   004A AF          			XOR	A					; Reset carry flag
0086   004B E1          TOUT:		POP	HL
0087   004C C1          			POP	BC
0088   004D C9          			RET
0089   004E             
0090   004E             ;================================================================================================
0091   004E             ; Console Status (Return A=0FFh if character waiting. Otherwise, A=0)
0092   004E             ;================================================================================================
0093   004E C5          CONST:		PUSH	BC
0094   004F E5          			PUSH	HL
0095   0050 DB 81       			IN	A,(USART_STA)
0096   0052 FE 00       			CP	0					; Reset carry flag
0097   0054 28 02       			JR	Z,CONVOID
0098   0056 3E FF       			LD	A,0FFH
0099   0058             CONVOID:
0100   0058 E1          			POP	HL
0101   0059 C1          			POP	BC
0102   005A C9          			RET
0103   005B             
0104   005B             ;================================================================================================
0105   005B             ; Console Input (Wait for input and return character in A)
0106   005B             ;================================================================================================
0107   005B C5          CONIN:		PUSH	BC
0108   005C E5          			PUSH	HL
0109   005D CD 4E 00    AGAIN:		CALL	CONST
0110   0060 FE 00       			CP	0
0111   0062 28 F9       			JR	Z,AGAIN			; Keep trying till we receive something
0112   0064 DB 80       			IN	A,(USART_DAT)
0113   0066 E1          EOCONIN:	POP	HL
0114   0067 C1          			POP	BC
0115   0068 C9          			RET					; Char read returns in A
0116   0069             
0117   0069             ;================================================================================================
0118   0069             ; Console Output (Send character in reg C)
0119   0069             ;================================================================================================
0120   0069 79          CONOUT:		LD	A,C
0121   006A D3 80       			OUT	(USART_DAT),A		; send character
0122   006C C9          			RET
0123   006D             
0124   006D             ;==================================================================================
0125   006D 00          RETRY		.DB 0					; Retry counter
0126   006E             
0127   006E             			.DS	020h				; Start of stack area.
0128   008E             STACK		.EQU	$
0129   008E             
0130   008E             
0131   008E             			.END
Number of errors = 0
