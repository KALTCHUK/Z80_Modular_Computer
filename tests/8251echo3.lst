---------------------------------------------
Z80 ASSEMBLER LISTING
Line   Addr Opcode      Label   Instruction
---------------------------------------------
0001   0000             ;==================================================================================
0002   0000             ; Read chars coming from console and echo them back
0003   0000             ;
0004   0000             ;
0005   0000             ;==================================================================================
0006   0000             
0007   0000             ; USART stuff
0008   0000             USART_DAT		.EQU	0D0H		; USART data addr
0009   0000             USART_CMD		.EQU	0D1H		; USART command addr
0010   0000             USART_STA		.EQU	0D1H		; USART status addr
0011   0000             UMODE			.EQU	06FH		; 8N1 (8 bit, no parity, 1 stop), baud=clock/64
0012   0000             UCMD0			.EQU	015H		; initial command: Rx enable, Tx enable, reset error flags
0013   0000             
0014   0000             ;================================================================================================
0015   0000             			.ORG 0
0016   0000 C3 5B 00    		JP	BOOT
0017   0003             
0018   0003             			.ORG	038H
0019   0038             ;================================================================================================
0020   0038             ; Interrupt routine called by USART
0021   0038             ;================================================================================================
0022   0038             UINT:
0023   0038 C5          		PUSH	BC
0024   0039 E5          		PUSH	HL
0025   003A             
0026   003A DB D0       		IN	A,(USART_DAT)		; read incoming byte
0027   003C D3 D0       		OUT	(USART_DAT),A		; send character
0028   003E ED 4B 50 40 		LD	BC,(WRPTR)
0029   0042 02          		LD	(BC),A
0030   0043 03          		INC	BC
0031   0044 21 50 40    		LD	HL,BUFEND
0032   0047 37          		SCF
0033   0048 3F          		CCF
0034   0049 ED 42       		SBC	HL,BC
0035   004B 20 03       		JR	NZ,EOINT
0036   004D 01 00 40    		LD	BC,BUFINI
0037   0050 ED 43 50 40 EOINT:	LD	(WRPTR),BC
0038   0054             
0039   0054 E1          		POP	HL
0040   0055 C1          		POP	BC
0041   0056 ED 56       		IM	1
0042   0058 FB          		EI
0043   0059 ED 4D       		RETI
0044   005B             
0045   005B             ;================================================================================================
0046   005B             ; Cold boot (/RESET = --\___/--)
0047   005B             ;================================================================================================
0048   005B             
0049   005B             BOOT:
0050   005B F3          		DI					; Disable interrupts.
0051   005C 31 74 40    		LD	SP,BIOSSTACK
0052   005F             
0053   005F CD 68 00    		CALL USARTINIT
0054   0062             
0055   0062 ED 56       		IM	1
0056   0064 FB          		EI
0057   0065             
0058   0065             ;================================================================================================
0059   0065             ; Start Xmitting
0060   0065             ;================================================================================================
0061   0065 00          LOOP:		NOP
0062   0066 18 FD       		JR	LOOP
0063   0068             
0064   0068             ;================================================================================================
0065   0068             ; Initialize USART
0066   0068             ;================================================================================================
0067   0068             USARTINIT:
0068   0068 3E 00       		LD 	A,0				; Worst case init: put in SYNC mode, send 2 dummy 00 sync chars and reset
0069   006A D3 D1       		OUT	(USART_CMD),A
0070   006C 00          		NOP
0071   006D D3 D1       		OUT	(USART_CMD),A
0072   006F 00          		NOP
0073   0070 D3 D1       		OUT	(USART_CMD),A
0074   0072 3E 40       		LD 	A,040H			; Reset USART
0075   0074 D3 D1       		OUT	(USART_CMD),A
0076   0076 3E 6F       		LD 	A,UMODE			; Set USART mode
0077   0078 D3 D1       		OUT	(USART_CMD),A
0078   007A 3E 15       		LD 	A,UCMD0			; Set USART initial command
0079   007C D3 D1       		OUT	(USART_CMD),A
0080   007E C9          		RET
0081   007F             
0082   007F             ;================================================================================================
0083   007F             			.ORG	04000H		; RAM starts here
0084   4000             BUFINI		.EQU	$
0085   4000             			.DS	050H
0086   4050             BUFEND		.EQU	$
0087   4050             WRPTR:		.DS	2			; write pointer
0088   4052             RDPTR:		.DS	2			; read pointer
0089   4054             			.DS	020h			; Start of BIOS stack area.
0090   4074             BIOSSTACK:		.EQU	$
0091   4074             			.END
Number of errors = 0
